<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reality Engine (Rust + WebGPU)</title>
    <!-- Cybercore CSS (or similar aesthetic) -->
    <link rel="stylesheet" href="https://unpkg.com/cybercore-css@latest/dist/cybercore.min.css">
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Courier New', monospace; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 0; }

        #ui-layer {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 320px;
            z-index: 10;
            pointer-events: none; /* Let clicks pass through to canvas where not on controls */
        }

        .cyber-card {
            pointer-events: auto; /* Re-enable clicks on the card */
            background: rgba(10, 10, 15, 0.85);
            border: 1px solid #00f0ff;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.2);
            padding: 20px;
            margin-bottom: 15px;
            backdrop-filter: blur(5px);
            clip-path: polygon(
                0 0,
                100% 0,
                100% calc(100% - 20px),
                calc(100% - 20px) 100%,
                0 100%
            );
        }

        .cyber-header {
            color: #00f0ff;
            font-size: 1.2rem;
            text-transform: uppercase;
            border-bottom: 1px solid #00f0ff;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-shadow: 0 0 5px #00f0ff;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: flex;
            justify-content: space-between;
            color: #ccc;
            margin-bottom: 8px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            background: #222;
            height: 4px;
            outline: none;
            border: 1px solid #444;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #00f0ff;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 0 10px #00f0ff;
        }

        select {
            width: 100%;
            background: #222;
            color: #00f0ff;
            border: 1px solid #444;
            padding: 5px;
            font-family: 'Courier New', monospace;
            outline: none;
            cursor: pointer;
        }

        .value-display {
            color: #00f0ff;
            font-family: monospace;
            font-weight: bold;
        }

        #log-area {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 400px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #05ffa1;
            background: rgba(0,0,0,0.8);
            border: 1px solid #05ffa1;
            border-left: 5px solid #05ffa1;
            padding: 15px;
            pointer-events: auto;
            z-index: 10;
            box-shadow: 0 0 10px rgba(5, 255, 161, 0.2);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #00f0ff; }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255,255,255,0),
                rgba(255,255,255,0) 50%,
                rgba(0,0,0,0.1) 50%,
                rgba(0,0,0,0.1)
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 999;
            opacity: 0.3;
        }

        #ar-feed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            display: none;
        }

        .cyber-button {
            width: 100%;
            background: rgba(0, 240, 255, 0.1);
            color: #00f0ff;
            border: 1px solid #00f0ff;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            margin-top: 5px;
        }

        .cyber-button:hover {
            background: #00f0ff;
            color: #000;
            box-shadow: 0 0 10px #00f0ff;
        }
    </style>
</head>
<body>
    <video id="ar-feed" autoplay playsinline></video>
    <div class="scanline"></div>
    <canvas id="reality-canvas"></canvas>

    <div id="ui-layer">
        <div class="cyber-card">
            <div class="cyber-header">Anomaly Projector</div>

            <div class="control-group">
                <label>Archetype</label>
                <select id="param-archetype">
                    <option value="1" selected>SciFi</option>
                    <option value="0">Fantasy</option>
                    <option value="2">Horror</option>
                    <option value="3">Toon</option>
                </select>
            </div>

            <div class="control-group">
                <label>Roughness <span id="val-rough" class="value-display">0.80</span></label>
                <input type="range" id="param-roughness" min="0" max="1" step="0.01" value="0.8">
            </div>

            <div class="control-group">
                <label>Scale <span id="val-scale" class="value-display">5.0</span></label>
                <input type="range" id="param-scale" min="0.1" max="10" step="0.1" value="5.0">
            </div>

            <div class="control-group">
                <label>Distortion <span id="val-dist" class="value-display">0.80</span></label>
                <input type="range" id="param-distortion" min="0" max="1" step="0.01" value="0.8">
            </div>

            <div style="margin-top: 20px; font-size: 0.8em; color: #888; border-top: 1px solid #333; padding-top: 10px;">
                STATUS: <span style="color: #ff2a6d; font-weight: bold; animation: blink 1s infinite;">UNSTABLE</span>
            </div>
        </div>

        <div class="cyber-card" style="margin-top: 10px;">
             <button id="btn-start-ar" class="cyber-button">INITIALIZE AR UPLINK</button>
        </div>

        <div class="cyber-card" style="margin-top: 10px;">
            <div class="cyber-header" style="font-size: 1rem; margin-bottom: 10px;">Instructions</div>
            <div style="font-size: 0.85rem; color: #aaa; line-height: 1.4;">
                [WASD] Move Camera<br>
                [Mouse] Click to Move Anomaly<br>
                [Sliders] Adjust Reality Params
            </div>
        </div>
    </div>

    <div id="log-area">
        <div>> SYSTEM BOOT_SEQUENCE_INIT</div>
        <div>> CHECKING_REALITY_INTEGRITY...</div>
        <div>> WARNING: ANOMALY DETECTED</div>
    </div>

    <style>
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
    </style>

    <script type="module">
        import init, { start } from './pkg/reality_engine.js';

        async function run() {
            try {
                log("> LOADING WASM MODULES...");
                await init();
                log("> WASM INITIALIZED OK");

                log("> STARTING ENGINE...");
                const gameClient = await start("reality-canvas");

                log("> CORE LINK ESTABLISHED");
                log("> RENDER LOOP ACTIVE");

                // UI Elements
                const archetypeSelect = document.getElementById('param-archetype');
                const roughSlider = document.getElementById('param-roughness');
                const scaleSlider = document.getElementById('param-scale');
                const distSlider = document.getElementById('param-distortion');

                const valRough = document.getElementById('val-rough');
                const valScale = document.getElementById('val-scale');
                const valDist = document.getElementById('val-dist');

                function updateParams() {
                    const r = parseFloat(roughSlider.value);
                    const s = parseFloat(scaleSlider.value);
                    const d = parseFloat(distSlider.value);

                    valRough.innerText = r.toFixed(2);
                    valScale.innerText = s.toFixed(1);
                    valDist.innerText = d.toFixed(2);

                    gameClient.set_anomaly_params(r, s, d);
                }

                // Listeners
                archetypeSelect.addEventListener('change', () => {
                     const val = parseInt(archetypeSelect.value);
                     log(`> PARAM_UPDATE: ARCHETYPE_ID = ${val}`);
                     gameClient.set_anomaly_archetype(val);
                });

                roughSlider.addEventListener('input', () => {
                    updateParams();
                    // Optional: log occasionally or on change end
                });

                roughSlider.addEventListener('change', () => {
                     log(`> PARAM_UPDATE: ROUGHNESS = ${roughSlider.value}`);
                });

                scaleSlider.addEventListener('input', updateParams);
                scaleSlider.addEventListener('change', () => {
                     log(`> PARAM_UPDATE: SCALE = ${scaleSlider.value}`);
                });

                distSlider.addEventListener('input', updateParams);
                 distSlider.addEventListener('change', () => {
                     log(`> PARAM_UPDATE: DISTORTION = ${distSlider.value}`);
                });

                // AR Button Logic
                const btnAR = document.getElementById('btn-start-ar');
                const videoFeed = document.getElementById('ar-feed');

                btnAR.addEventListener('click', async () => {
                    log("> INITIALIZING AR UPLINK...");
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: "environment" }
                        });
                        videoFeed.srcObject = stream;
                        videoFeed.style.display = 'block';
                        videoFeed.play();
                        log("> VIDEO FEED ESTABLISHED");

                        // iOS 13+ DeviceOrientation permission
                        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                             log("> REQUESTING SENSOR PERMISSION...");
                             const response = await DeviceOrientationEvent.requestPermission();
                             if (response == 'granted') {
                                 log("> SENSOR PERMISSION GRANTED");
                             } else {
                                 log("> SENSOR PERMISSION DENIED");
                             }
                        }
                    } catch (e) {
                        console.error(e);
                        log("> AR FAILURE: " + e.message);
                    }
                });

            } catch (e) {
                console.error("Failed to start engine:", e);
                log("> CRITICAL FAILURE: " + e);
            }
        }

        function log(msg) {
            const area = document.getElementById('log-area');
            const line = document.createElement('div');
            // Add timestamp
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            line.innerText = `[${time}] ${msg}`;
            area.appendChild(line);
            area.scrollTop = area.scrollHeight;
        }

        run();
    </script>
</body>
</html>
